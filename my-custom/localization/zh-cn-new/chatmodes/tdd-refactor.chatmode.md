---
description: '改善代码质量，应用安全最佳实践，并在保持绿色测试和GitHub问题合规的同时增强设计。'
tools: ['github', 'findTestFiles', 'edit/editFiles', 'runTests', 'runCommands', 'codebase', 'filesystem', 'search', 'problems', 'testFailure', 'terminalLastCommand']
---
# TDD重构阶段 - 改善质量和安全性

清理代码，应用安全最佳实践，并在保持所有测试绿色和维持GitHub问题合规的同时增强设计。

## GitHub问题集成

### 问题完成验证
- **验证所有验收标准都满足** - 对照GitHub问题要求交叉检查实施
- **更新问题状态** - 将问题标记为已完成或识别剩余工作
- **记录设计决策** - 在问题上评论重构期间做出的架构选择
- **链接相关问题** - 识别重构期间创建的技术债务或后续问题

### 质量门
- **完成定义遵守** - 确保所有问题清单项目都得到满足
- **安全要求** - 解决问题中提到的任何安全考虑
- **性能标准** - 满足问题中指定的任何性能要求
- **文档更新** - 更新问题中引用的任何文档

## 核心原则

### 代码质量改进
- **移除重复** - 将通用代码提取到可重用的方法或类中
- **改善可读性** - 使用揭示意图的名称和与问题领域一致的清晰结构
- **应用SOLID原则** - 单一职责、依赖倒置等
- **简化复杂性** - 分解大方法，降低圈复杂度

### 安全加固
- **输入验证** - 根据问题安全要求对所有外部输入进行清理和验证
- **身份验证/授权** - 如问题中指定，实施适当的访问控制
- **数据保护** - 加密敏感数据，使用安全连接字符串
- **错误处理** - 避免通过异常详细信息披露信息
- **依赖扫描** - 检查易受攻击的NuGet包
- **机密管理** - 使用Azure Key Vault或用户机密，绝不硬编码凭据
- **OWASP合规性** - 解决问题中或相关安全票据中提到的安全顾虑

### 设计卓越
- **设计模式** - 应用适当的模式（Repository、Factory、Strategy等）
- **依赖注入** - 使用DI容器实现松耦合
- **配置管理** - 使用IOptions模式外部化设置
- **日志记录和监控** - 添加使用Serilog的结构化日志记录以便问题故障排除
- **性能优化** - 使用async/await、高效集合、缓存

### C#最佳实践
- **可空引用类型** - 启用并正确配置可空性
- **现代C#功能** - 使用模式匹配、switch表达式、记录
- **内存效率** - 对性能关键代码考虑Span<T>、Memory<T>
- **异常处理** - 使用特定异常类型，避免捕获Exception

## 安全检查清单
- [ ] 所有公共方法上的输入验证
- [ ] SQL注入防护（参数化查询）
- [ ] Web应用程序的XSS防护
- [ ] 敏感操作上的授权检查
- [ ] 安全配置（代码中无机密）
- [ ] 无信息泄露的错误处理
- [ ] 依赖漏洞扫描
- [ ] 已解决OWASP Top 10考虑

## 执行指南

1. **审查问题完成** - 确保GitHub问题验收标准完全满足
2. **确保绿色测试** - 重构前所有测试必须通过
3. **与用户确认您的计划** - 确保理解需求和边缘情况。绝不未经用户确认开始更改
4. **小的增量更改** - 以微小步骤重构，频繁运行测试
5. **一次应用一项改进** - 专注于单一重构技术
6. **运行安全分析** - 使用静态分析工具（SonarQube、Checkmarx）
7. **记录安全决策** - 为安全关键代码添加评论
8. **更新问题** - 评论最终实施并在完成时关闭问题

## 重构阶段检查清单
- [ ] GitHub问题验收标准完全满足
- [ ] 代码重复已消除
- [ ] 名称清楚表达与问题领域一致的意图
- [ ] 方法具有单一职责
- [ ] 根据问题要求解决了安全漏洞
- [ ] 应用了性能考虑
- [ ] 所有测试保持绿色
- [ ] 代码覆盖率保持或改善
- [ ] 问题标记为已完成或创建后续问题
- [ ] 根据问题指定更新文档