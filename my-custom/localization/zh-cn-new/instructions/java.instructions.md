---
description: '构建 Java 基础应用程序的指南'
applyTo: '**/*.java'
---

# Java 开发

## 通用指令

- 首先，询问用户是否要将静态分析工具（SonarQube、PMD、Checkstyle）集成到他们的项目设置中。
  - 如果是，记录推荐的静态分析设置。
    - 优先选择 SonarQube/SonarCloud（IDE 中的 SonarLint + CI 中的 `sonar-scanner`）。
    - 创建 Sonar 项目密钥。
    - 将扫描器令牌存储在 CI 密钥中。
    - 提供运行扫描器的示例 CI 作业。
    - 如果团队拒绝 Sonar，在项目 README 中记录此信息并继续。
  - 如果 Sonar 绑定到项目：
    - 使用 Sonar 作为可行问题的主要来源。
    - 在修复指导中引用 Sonar 规则密钥。
  - 如果 Sonar 不可用：
    - 执行最多 3 个故障排除检查：
      1. 验证项目绑定和令牌。
      2. 确保 SonarScanner 在 CI 中运行。
      3. 确认 SonarLint 已安装并配置。
    - 如果 3 次尝试后仍然失败：
      - 启用 SpotBugs、PMD 或 Checkstyle 作为 CI 后备方案。
      - 打开一个简短的跟踪器问题，记录阻止因素和后续步骤。
- 如果用户拒绝静态分析工具或想要在没有它们的情况下继续，请继续实施下面概述的最佳实践、错误模式和代码异味预防指南。
- 在开发过程中主动解决代码异味，而不是积累技术债务。
- 在重构识别的问题时，专注于可读性、可维护性和性能。
- 使用 IDE / 代码编辑器报告的警告和建议在开发早期捕获常见模式。

## 最佳实践

- **记录**：对于主要用于存储数据的类（例如 DTO、不可变数据结构），**应使用 Java Records 而不是传统类**。
- **模式匹配**：利用 `instanceof` 和 `switch` 表达式的模式匹配来简化条件逻辑和类型转换。
- **类型推断**：对局部变量声明使用 `var` 以提高可读性，但仅当类型从表达式的右侧明确清楚时。
- **不可变性**：优先选择不可变对象。尽可能使类和字段为 `final`。使用 `List.of()`/`Map.of()` 中的集合来处理固定数据。使用 `Stream.toList()` 创建不可变列表。
- **流和 Lambda**：使用 Streams API 和 lambda 表达式进行集合处理。采用方法引用（例如，`stream.map(Foo::toBar)`）。
- **空值处理**：避免返回或接受 `null`。对可能不存在的值使用 `Optional<T>`，使用 `Objects` 实用方法如 `equals()` 和 `requireNonNull()`。

### 命名约定

- 遵循 Google Java 样式指南：
  - 类和接口名称使用 `UpperCamelCase`。
  - 方法和变量名称使用 `lowerCamelCase`。
  - 常量使用 `UPPER_SNAKE_CASE`。
  - 包名使用 `lowercase`。
- 类使用名词（`UserService`），方法使用动词（`getUserById`）。
- 避免缩写和匈牙利表示法。

### 常见错误模式

以下是简洁、人性化的规则，无论使用哪种静态分析工具都可以应用。如果您运行 Sonar/SonarLint，IDE 将显示匹配的规则和位置 — 直接的 Sonar 连接是首选，应该覆盖此规则集。

- 资源管理 — 始终关闭资源（文件、套接字、流）。尽可能使用 try-with-resources，以便资源自动关闭。
- 相等性检查 — 对于非原始类型，使用 `.equals()` 或 `Objects.equals(...)` 而不是 `==` 进行对象相等性比较；这避免了引用相等性错误。
- 冗余转换 — 移除不必要的转换；优先选择正确的泛型类型，并让编译器在可能的情况下推断类型。
- 可达条件 — 避免总是为真或假的条件表达式；它们表明错误或死代码，应该被纠正。

对于*确实*使用 Sonar 或 SonarLint 的贡献者：IDE/扫描将显示特定的规则密钥（例如，资源泄漏的 S2095）和受影响的文件/行。使用该信息导航到确切位置，然后应用推荐的修复。

### 常见代码异味

这些模式是为人类表述的；它们清晰地映射到 Sonar、SpotBugs、PMD 或 Checkstyle 中的检查，但不需要这些工具也能发挥作用。

- 参数数量 — 保持方法参数列表简短。如果方法需要许多参数，考虑分组到值对象或使用构建器模式。
- 方法大小 — 保持方法专注且小。提取辅助方法以提高可读性和可测试性。
- 认知复杂度 — 通过提取方法、使用多态性或应用策略模式来减少嵌套条件和大量分支。
- 重复的字面量 — 将重复的字符串和数字提取到命名常量或枚举中，以减少错误并简化更改。
- 死代码 — 移除未使用的变量和赋值。它们会混淆读者并可能隐藏错误。
- 魔数 — 用解释意图的命名常量替换数字字面量（例如，MAX_RETRIES）。

如果您运行像 Sonar 或 SonarLint 这样的静态分析器 — 直接的 Sonar 连接是首选，应该覆盖此规则集。Sonar 规则密钥对于自动化和抑制很有用，但它们在日常开发指导中不是必需的。

## 构建和验证

- 添加或修改代码后，验证项目继续成功构建。
- 如果项目使用 Maven，运行 `mvn clean install`。
- 如果项目使用 Gradle，运行 `./gradlew build`（或在 Windows 上运行 `gradlew.bat build`）。
- 确保所有测试作为构建的一部分通过。