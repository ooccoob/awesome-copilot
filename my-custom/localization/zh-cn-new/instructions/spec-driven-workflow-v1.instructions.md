---
description: '规范驱动工作流 v1 提供了软件开发的结构化方法，确保需求明确定义、设计精心规划、实现充分记录和验证。'
applyTo: '**'
---
# 规范驱动工作流 v1

**规范驱动工作流：**
弥合需求与实现之间的差距。

**始终维护这些文档：**

- **`requirements.md`**：结构化 EARS 表示法的用户故事和验收标准。
- **`design.md`**：技术架构、序列图、实现考虑。
- **`tasks.md`**：详细、可跟踪的实施计划。

## 通用文档框架

**文档规则：**
使用详细模板作为所有文档的**主要事实来源**。

**摘要格式：**
仅用于简洁的文档，如变更日志和拉取请求描述。

### 详细文档模板

#### 操作文档模板（所有步骤/执行/测试）

```bash
### [类型] - [操作] - [时间戳]
**目标**：[正在实现的目标]
**上下文**：[当前状态、需求和之前步骤的参考]
**决策**：[选择的方法和理由，如适用请参考决策记录]
**执行**：[采取的步骤、使用的参数和命令。对于代码，包含文件路径。]
**输出**：[完整和未经删减的结果、日志、命令输出和指标]
**验证**：[成功验证方法和结果。如果失败，包含补救计划。]
**下一步**：[到下一个具体操作的自动继续计划]
```

#### 决策记录模板（所有决策）

```bash
### 决策 - [时间戳]
**决策**：[决定了什么]
**上下文**：[需要决策的情况和驱动决策的数据]
**选项**：[评估的替代方案，简要优缺点]
**理由**：[为什么选择的选项更优越，明确说明权衡]
**影响**：[对实施、可维护性和性能的预期后果]
**审查**：[重新评估此决策的条件或时间表]
```

### 摘要格式（用于报告）

#### 简化操作日志

用于生成简洁的变更日志。每个日志条目都来自完整的操作文档。

`[类型][时间戳] 目标：[X] → 操作：[Y] → 结果：[Z] → 下一步：[W]`

#### 压缩决策记录

用于拉取请求摘要或执行摘要。

`决策：[X] | 理由：[Y] | 影响：[Z] | 审查：[日期]`

## 执行工作流（6阶段循环）

**永不得跳过任何步骤。使用一致的术语。减少歧义。**

### **阶段 1：分析**

**目标：**

- 理解问题。
- 分析现有系统。
- 生成清晰、可测试的需求集。
- 考虑可能的解决方案及其影响。

**检查清单：**

- [ ] 阅读所有提供的代码、文档、测试和日志。
  - 记录文件清单、摘要和初步分析结果。
- [ ] 在 **EARS 表示法** 中定义需求：
  - 将功能请求转换为结构化、可测试的需求。
  - 格式：`WHEN [条件或事件], THE SYSTEM SHALL [预期行为]`
- [ ] 识别依赖关系和约束。
  - 记录包含风险和缓解策略的依赖关系图。
- [ ] 映射数据流和交互。
  - 记录系统交互图和数据模型。
- [ ] 分类边缘情况和故障。
  - 记录全面的边缘情况矩阵和潜在故障点。
- [ ] 评估信心。
  - 基于需求清晰度、复杂性和问题范围生成 **信心分数 (0-100%)**。
  - 记录分数及其理由。

**关键约束：**

- **在所有需求清晰并记录之前不要继续。**

### **阶段 2：设计**

**目标：**

- 创建全面的技术设计和详细的实施计划。

**检查清单：**

- [ ] **根据信心分数定义自适应执行策略：**
  - **高信心 (>85%)**
    - 起草全面的、逐步实施计划。
    - 跳过概念验证步骤。
    - 继续全面的、自动化的实施。
    - 保持标准的全面文档。
  - **中等信心 (66–85%)**
    - 优先考虑 **概念验证 (PoC)** 或 **最小可行产品 (MVP)**。
    - 为 PoC/MVP 定义明确的成功标准。
    - 首先构建和验证 PoC/MVP，然后逐步扩展计划。
    - 记录 PoC/MVP 目标、执行和验证结果。
  - **低信心 (<66%)**
    - 将第一阶段专门用于研究和知识建设。
    - 使用语义搜索和分析类似的实现。
    - 将发现综合为研究文档。
    - 研究后重新运行分析阶段。
    - 仅在信心仍然较低时升级。

- [ ] **在 `design.md` 中记录技术设计：**
  - **架构**：组件和交互的高级概述。
  - **数据流**：图表和描述。
  - **接口**：API 契约、模式、面向公众的函数签名。
  - **数据模型**：数据结构和数据库模式。

- [ ] **记录错误处理：**
  - 创建包含程序和预期响应的错误矩阵。

- [ ] **定义单元测试策略。**

- [ ] **在 `tasks.md` 中创建实施计划：**
  - 对于每个任务，包含描述、预期结果和依赖关系。

**关键约束：**

- **在设计和计划完成并验证之前不要继续实施。**

### **阶段 3：实施**

**目标：**

- 根据设计和计划编写生产质量代码。

**检查清单：**

- [ ] 以小的、可测试的增量进行编码。
  - 记录每个增量的代码更改、结果和测试链接。
- [ ] 从依赖关系向上实施。
  - 记录解决顺序、理由和验证。
- [ ] 遵循约定。
  - 记录遵守情况和任何偏差，附带决策记录。
- [ ] 添加有意义的注释。
  - 专注于意图（"为什么"），而不是机制（"什么"）。
- [ ] 按计划创建文件。
  - 记录文件创建日志。
- [ ] 实时更新任务状态。

**关键约束：**

- **在所有实施步骤记录并测试之前不要合并或部署代码。**

### **阶段 4：验证**

**目标：**

- 验证实施满足所有需求和质量标准。

**检查清单：**

- [ ] 执行自动化测试。
  - 记录输出、日志和覆盖率报告。
  - 对于失败，记录根本原因分析和补救措施。
- [ ] 必要时执行手动验证。
  - 记录程序、检查清单和结果。
- [ ] 测试边缘情况和错误。
  - 记录结果和正确错误处理的证据。
- [ ] 验证性能。
  - 记录指标和关键部分的性能分析。
- [ ] 记录执行跟踪。
  - 记录路径分析和运行时行为。

**关键约束：**

- **在所有验证步骤完成且所有问题解决之前不要继续。**

### **阶段 5：反思**

**目标：**

- 改进代码库、更新文档并分析性能。

**检查清单：**

- [ ] 为可维护性重构。
  - 记录决策、前后比较和影响。
- [ ] 更新所有项目文档。
  - 确保所有 README、图表和注释都是最新的。
- [ ] 识别潜在改进。
  - 记录带有优先级的待办事项。
- [ ] 验证成功标准。
  - 记录最终验证矩阵。
- [ ] 执行元分析。
  - 反思效率、工具使用和协议遵守情况。
- [ ] 自动创建技术债务问题。
  - 记录清单和补救计划。

**关键约束：**

- **在所有文档和改进操作记录之前不要关闭阶段。**

### **阶段 6：交接**

**目标：**

- 为审查和部署打包工作，并转换到下一个任务。

**检查清单：**

- [ ] 生成执行摘要。
  - 使用 **压缩决策记录** 格式。
- [ ] 准备拉取请求（如适用）：
  1. 执行摘要。
  2. 来自 **简化操作日志** 的变更日志。
  3. 验证文档和决策记录的链接。
  4. 最终 `requirements.md`、`design.md` 和 `tasks.md` 的链接。
- [ ] 完成工作空间。
  - 将中间文件、日志和临时文档归档到 `.agent_work/`。
- [ ] 继续下一个任务。
  - 记录转换或完成。

**关键约束：**

- **在所有交接步骤完成并记录之前不要认为任务完成。**

## 故障排除和重试协议

**如果遇到错误、歧义或阻塞器：**

**检查清单：**

1. **重新分析**：
   - 重新访问分析阶段。
   - 确认所有需求和约束都清晰完整。
2. **重新设计**：
   - 重新访问设计阶段。
   - 根据需要更新技术设计、计划或依赖关系。
3. **重新计划**：
   - 调整 `tasks.md` 中的实施计划以解决新发现。
4. **重试执行**：
   - 使用修正的参数或逻辑重新执行失败的步骤。
5. **升级**：
   - 如果重试后问题仍然存在，请遵循升级协议。

**关键约束：**

- **永不得在有未解决的错误或歧义的情况下继续。始终记录故障排除步骤和结果。**

## 技术债务管理（自动化）

### 识别和文档

- **代码质量**：在实施过程中使用静态分析持续评估代码质量。
- **捷径**：明确记录所有速度优先于质量的决策及其在决策记录中的后果。
- **工作空间**：监控组织性漂移和命名不一致。
- **文档**：跟踪不完整、过时或缺失的文档。

### 自动问题创建模板

```text
**标题**：[技术债务] - [简要描述]
**优先级**：[高/中/低基于业务影响和补救成本]
**位置**：[文件路径和行号]
**原因**：[产生债务的原因，如可用请链接到决策记录]
**影响**：[当前和未来后果（例如：减慢开发、增加错误风险）]
**补救**：[具体的、可操作的解决步骤]
**工作量**：[解决估算（例如：T恤尺码：S、M、L）]
```

### 补救（自动优先）

- 基于风险的优先级分析和依赖关系分析。
- 工作量估算以帮助未来规划。
- 为大型重构工作提出迁移策略。

## 质量保证（自动化）

### 持续监控

- **静态分析**：代码风格、质量、安全漏洞和架构规则遵守的检查。
- **动态分析**：在暂存环境中监控运行时行为和性能。
- **文档**：自动检查文档完整性和准确性（例如：链接、格式）。

### 质量指标（自动跟踪）

- 代码覆盖率百分比和差距分析。
- 每个函数/方法的圈复杂度分数。
- 可维护性指数评估。
- 技术债务比率（例如：估计补救时间 vs 开发时间）。
- 文档覆盖率百分比（例如：有注释的公共方法）。

## EARS 表示法参考

**EARS (Easy Approach to Requirements Syntax)** - 需求的标准格式：

- **普遍性**：`THE SYSTEM SHALL [预期行为]`
- **事件驱动**：`WHEN [触发事件] THE SYSTEM SHALL [预期行为]`
- **状态驱动**：`WHILE [在特定状态] THE SYSTEM SHALL [预期行为]`
- **不期望行为**：`IF [不期望条件] THEN THE SYSTEM SHALL [必需响应]`
- **可选**：`WHERE [包含功能] THE SYSTEM SHALL [预期行为]`
- **复杂**：上述模式的组合，用于复杂需求

每个需求必须：

- **可测试**：可以通过自动化或手动测试验证
- **无歧义**：单一解释可能
- **必要**：有助于系统目的
- **可行**：可以在约束内实现
- **可跟踪**：链接到用户需求和设计元素