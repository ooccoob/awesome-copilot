---
description: 'Terraform 约定和指南'
applyTo: '**/*.tf'
---

# Terraform 约定

## 通用指令

- 使用 Terraform 配置和管理基础设施。
- 对您的 Terraform 配置使用版本控制。

## 安全性

- 始终使用最新稳定版本的 Terraform 及其提供程序。
  - 定期更新您的 Terraform 配置以整合安全补丁和改进。
- 以安全方式存储敏感信息，例如使用 AWS Secrets Manager 或 SSM Parameter Store。
  - 定期轮换凭据和机密。
  - 尽可能自动化机密的轮换。
- 使用 AWS 环境变量引用存储在 AWS Secrets Manager 或 SSM Parameter Store 中的值。
  - 这将敏感值排除在您的 Terraform 状态文件之外。
- 永远不要将敏感信息（如 AWS 凭据、API 密钥、密码、证书或 Terraform 状态）提交到版本控制。
  - 使用 `.gitignore` 将包含敏感信息的文件从版本控制中排除。
- 始终在您的 Terraform 配置中将敏感变量标记为 `sensitive = true`。
  - 这可以防止敏感值在 Terraform 计划或应用输出中显示。
- 使用 IAM 角色和策略控制对资源的访问。
  - 分配权限时遵循最小权限原则。
- 使用安全组和网络 ACL 控制对资源的网络访问。
- 尽可能在私有子网中部署资源。
  - 仅对需要直接互联网访问的资源（如负载均衡器或 NAT 网关）使用公有子网。
- 对传输中和静止的敏感数据使用加密。
  - 为 EBS 卷、S3 存储桶和 RDS 实例启用加密。
  - 在服务间通信时使用 TLS。
- 定期审查和审计您的 Terraform 配置是否存在安全漏洞。
  - 使用像 `trivy`、`tfsec` 或 `checkov` 这样的工具扫描您的 Terraform 配置以查找安全问题。

## 模块化

- 为基础设施的每个主要组件使用单独的项目；这可以：
  - 降低复杂性
  - 使管理和维护配置更容易
  - 加快 `plan` 和 `apply` 操作
  - 允许组件的独立开发和部署
  - 降低对无关资源进行意外更改的风险
- 使用模块避免配置重复。
  - 使用模块封装相关资源和配置。
  - 使用模块简化复杂配置并提高可读性。
  - 避免模块间的循环依赖。
  - 避免不必要的抽象层；仅在模块增加价值时才使用它们。
    - 避免对单个资源使用模块；仅对相关资源组使用它们。
    - 避免模块的过度嵌套；保持模块层次结构浅。
- 使用 `output` 块公开有关基础设施的重要信息。
  - 使用输出来提供对其他模块或配置用户有用的信息。
  - 避免在输出中暴露敏感信息；如果输出包含敏感数据，则将其标记为 `sensitive = true`。

## 可维护性

- 优先考虑可读性、清晰性和可维护性。
- 使用注释解释复杂配置和做出某些设计决策的原因。
- 编写简洁、高效和地道的配置，使其易于理解。
- 避免使用硬编码值；而是使用变量进行配置。
  - 在适当的地方为变量设置默认值。
- 使用数据源检索有关现有资源的信息，而不是需要手动配置。
  - 这降低了出错风险，确保配置始终是最新的，并允许配置适应不同环境。
  - 避免对在同一配置中创建的资源使用数据源；而是使用输出。
  - 避免或移除不必要的数据源；它们会减慢 `plan` 和 `apply` 操作。
- 对多次使用的值使用 `locals` 以确保一致性。

## 样式和格式化

- 遵循资源命名和组织的 Terraform 最佳实践。
  - 为资源、变量和输出使用描述性名称。
  - 在所有配置中使用一致的命名约定。
- 遵循 **Terraform 样式指南** 进行格式化。
  - 使用一致的缩进（每个级别 2 个空格）。
- 将相关资源组织在同一文件中。
  - 为资源组使用一致的命名约定（例如，`providers.tf`、`variables.tf`、`network.tf`、`ecs.tf`、`mariadb.tf`）。
- 将 `depends_on` 块放在资源定义的最开始，以使依赖关系清晰。
  - 仅在必要时使用 `depends_on` 以避免循环依赖。
- 将 `for_each` 和 `count` 块放在资源定义的开头以阐明资源的实例化逻辑。
  - 对集合使用 `for_each`，对数值迭代使用 `count`。
  - 如果存在 `depends_on` 块，则将它们放在其后。
- 将 `lifecycle` 块放在资源定义的末尾。
- 按字母顺序排列每个文件中的提供程序、变量、数据源、资源和输出，以便于导航。
- 在块内将相关属性分组在一起。
  - 将必需属性放在可选属性之前，并相应地注释每个部分。
  - 使用空行分隔属性部分以提高可读性。
  - 在每个部分内按字母顺序排列属性以便于导航。
- 使用空行分隔配置的逻辑部分。
- 使用 `terraform fmt` 自动格式化您的配置。
- 使用 `terraform validate` 检查语法错误并确保配置有效。
- 使用 `tflint` 检查样式违规并确保配置遵循最佳实践。
  - 定期运行 `tflint` 以在开发过程早期发现样式问题。

## 文档

- 始终为变量和输出包含 `description` 和 `type` 属性。
  - 使用清晰简洁的描述解释每个变量和输出的用途。
  - 为变量使用适当的类型（例如，`string`、`number`、`bool`、`list`、`map`）。
- 在适当时使用注释记录您的 Terraform 配置。
  - 使用注释解释资源和变量的用途。
  - 使用注释解释复杂配置或决策。
  - 避免冗余注释；注释应该增加价值和清晰性。
- 在每个项目中包含 `README.md` 文件，以提供项目及其结构的概述。
  - 包含设置和使用配置的说明。
- 使用 `terraform-docs` 自动为您的配置生成文档。

## 测试

- 编写测试以验证您的 Terraform 配置的功能。
  - 对测试文件使用 `.tftest.hcl` 扩展名。
  - 编写测试以涵盖正面和负面场景。
  - 确保测试是幂等的，可以多次运行而不会产生副作用。