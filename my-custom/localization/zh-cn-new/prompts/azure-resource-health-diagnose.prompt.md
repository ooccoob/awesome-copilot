---
mode: 'agent'
description: '分析Azure资源健康状况，从日志和遥测诊断问题，并为识别的问题创建修复计划。'
---

# Azure 资源健康状况与问题诊断

此工作流分析特定的Azure资源以评估其健康状况，使用日志和遥测数据诊断潜在问题，并为发现的任何问题制定全面的修复计划。

## 先决条件
- Azure MCP服务器已配置并身份验证
- 目标Azure资源已识别（名称，可选地资源组/订阅）
- 资源必须已部署并运行以生成日志/遥测
- 在可用时，优先使用Azure MCP工具（`azmcp-*`）而不是直接Azure CLI

## 工作流步骤

### 步骤1：获取Azure最佳实践
**操作**：检索诊断和故障排除最佳实践
**工具**：Azure MCP最佳实践工具
**流程**：
1. **加载最佳实践**：
   - 执行Azure最佳实践工具获取诊断指南
   - 专注于健康监控、日志分析和问题解决模式
   - 使用这些实践来指导诊断方法和修复建议

### 步骤2：资源发现和识别
**操作**：定位和识别目标Azure资源
**工具**：Azure MCP工具 + Azure CLI回退
**流程**：
1. **资源查找**：
   - 如果只提供资源名称：使用`azmcp-subscription-list`跨订阅搜索
   - 使用`az resource list --name <resource-name>`查找匹配资源
   - 如果找到多个匹配项，提示用户指定订阅/资源组
   - 收集详细资源信息：
     - 资源类型和当前状态
     - 位置、标签和配置
     - 关联服务和依赖项

2. **资源类型检测**：
   - 识别资源类型以确定适当的诊断方法：
     - **Web应用/函数应用**：应用程序日志、性能指标、依赖项跟踪
     - **虚拟机**：系统日志、性能计数器、启动诊断
     - **Cosmos DB**：请求指标、限制、分区统计
     - **存储账户**：访问日志、性能指标、可用性
     - **SQL数据库**：查询性能、连接日志、资源利用率
     - **Application Insights**：应用程序遥测、异常、依赖项
     - **密钥保管库**：访问日志、证书状态、密钥使用情况
     - **服务总线**：消息指标、死信队列、吞吐量

### 步骤3：健康状况评估
**操作**：评估当前资源健康和可用性
**工具**：Azure MCP监控工具 + Azure CLI
**流程**：
1. **基本健康检查**：
   - 检查资源预配状态和操作状态
   - 验证服务可用性和响应能力
   - 审查最近的部署或配置更改
   - 评估当前资源利用率（CPU、内存、存储等）

2. **服务特定健康指标**：
   - **Web应用**：HTTP响应代码、响应时间、正常运行时间
   - **数据库**：连接成功率、查询性能、死锁
   - **存储**：可用性百分比、请求成功率、延迟
   - **虚拟机**：启动诊断、来宾操作系统指标、网络连接
   - **函数**：执行成功率、持续时间、错误频率

### 步骤4：日志和遥测分析
**操作**：分析日志和遥测以识别问题和模式
**工具**：用于Log Analytics查询的Azure MCP监控工具
**流程**：
1. **查找监控源**：
   - 使用`azmcp-monitor-workspace-list`识别Log Analytics工作区
   - 定位与资源关联的Application Insights实例
   - 使用`azmcp-monitor-table-list`识别相关日志表

2. **执行诊断查询**：
   使用`azmcp-monitor-log-query`与基于资源类型的定向KQL查询：

   **一般错误分析**：
   ```kql
   // 最近的错误和异常
   union isfuzzy=true
       AzureDiagnostics,
       AppServiceHTTPLogs,
       AppServiceAppLogs,
       AzureActivity
   | where TimeGenerated > ago(24h)
   | where Level == "Error" or ResultType != "Success"
   | summarize ErrorCount=count() by Resource, ResultType, bin(TimeGenerated, 1h)
   | order by TimeGenerated desc
   ```

   **性能分析**：
   ```kql
   // 性能下降模式
   Perf
   | where TimeGenerated > ago(7d)
   | where ObjectName == "Processor" and CounterName == "% Processor Time"
   | summarize avg(CounterValue) by Computer, bin(TimeGenerated, 1h)
   | where avg_CounterValue > 80
   ```

   **应用程序特定查询**：
   ```kql
   // Application Insights - 失败的请求
   requests
   | where timestamp > ago(24h)
   | where success == false
   | summarize FailureCount=count() by resultCode, bin(timestamp, 1h)
   | order by timestamp desc

   // 数据库 - 连接失败
   AzureDiagnostics
   | where ResourceProvider == "MICROSOFT.SQL"
   | where Category == "SQLSecurityAuditEvents"
   | where action_name_s == "CONNECTION_FAILED"
   | summarize ConnectionFailures=count() by bin(TimeGenerated, 1h)
   ```

3. **模式识别**：
   - 识别重复的错误模式或异常
   - 将错误与部署时间或配置更改相关联
   - 分析性能趋势和下降模式
   - 查找依赖项故障或外部服务问题

### 步骤5：问题分类和根本原因分析
**操作**：对识别的问题进行分类并确定根本原因
**流程**：
1. **问题分类**：
   - **关键**：服务不可用、数据丢失、安全漏洞
   - **高**：性能下降、间歇性故障、高错误率
   - **中**：警告、次优配置、轻微性能问题
   - **低**：信息性警报、优化机会

2. **根本原因分析**：
   - **配置问题**：不正确的设置、缺少依赖项
   - **资源限制**：CPU/内存/磁盘限制、限制
   - **网络问题**：连接问题、DNS解析、防火墙规则
   - **应用程序问题**：代码错误、内存泄漏、低效查询
   - **外部依赖项**：第三方服务故障、API限制
   - **安全问题**：身份验证失败、证书过期

3. **影响评估**：
   - 确定业务影响和受影响的用户/系统
   - 评估数据完整性和安全影响
   - 评估恢复时间目标和优先级

### 步骤6：生成修复计划
**操作**：创建全面的计划以解决识别的问题
**流程**：
1. **立即行动**（关键问题）：
   - 恢复服务可用性的紧急修复
   - 减轻影响的临时解决方法
   - 复杂问题的升级程序

2. **短期修复**（高/中问题）：
   - 配置调整和资源缩放
   - 应用程序更新和补丁
   - 监控和警报改进

3. **长期改进**（所有问题）：
   - 更好弹性的架构更改
   - 预防措施和监控增强
   - 文档和流程改进

4. **实施步骤**：
   - 带有特定Azure CLI命令的优先级行动项
   - 测试和验证程序
   - 每个更改的回滚计划
   - 监控以验证问题解决

### 步骤7：用户确认和报告生成
**操作**：显示发现并获得修复行动的批准
**流程**：
1. **显示健康评估摘要**：
   ```
   🏥 Azure 资源健康评估

   📊 资源概览：
   • 资源：[名称] ([类型])
   • 状态：[健康/警告/关键]
   • 位置：[区域]
   • 最后分析：[时间戳]

   🚨 识别的问题：
   • 关键：X个需要立即关注的问题
   • 高：Y个影响性能/可靠性的问题
   • 中：Z个用于优化的问题
   • 低：N个信息性项目

   🔍 主要问题：
   1. [问题类型]：[描述] - 影响：[高/中/低]
   2. [问题类型]：[描述] - 影响：[高/中/低]
   3. [问题类型]：[描述] - 影响：[高/中/低]

   🛠️ 修复计划：
   • 立即行动：X个项目
   • 短期修复：Y个项目
   • 长期改进：Z个项目
   • 预估解决时间：[时间线]

   ❓ 继续详细修复计划？（y/n）
   ```

2. **生成详细报告**：
   ```markdown
   # Azure 资源健康报告：[资源名称]

   **生成时间**：[时间戳]
   **资源**：[完整资源ID]
   **整体健康状况**：[带颜色指示器的状态]

   ## 🔍 执行摘要
   [健康状况和关键发现的简要概述]

   ## 📊 健康指标
   - **可用性**：过去24小时内X%
   - **性能**：[平均响应时间/吞吐量]
   - **错误率**：过去24小时内X%
   - **资源利用率**：[CPU/内存/存储百分比]

   ## 🚨 识别的问题

   ### 关键问题
   - **[问题1]**：[描述]
     - **根本原因**：[分析]
     - **影响**：[业务影响]
     - **立即行动**：[所需步骤]

   ### 高优先级问题
   - **[问题2]**：[描述]
     - **根本原因**：[分析]
     - **影响**：[性能/可靠性影响]
     - **建议修复**：[解决方案步骤]

   ## 🛠️ 修复计划

   ### 阶段1：立即行动（0-2小时）
   ```bash
   # 恢复服务的关键修复
   [带解释的Azure CLI命令]
   ```

   ### 阶段2：短期修复（2-24小时）
   ```bash
   # 性能和可靠性改进
   [带解释的Azure CLI命令]
   ```

   ### 阶段3：长期改进（1-4周）
   ```bash
   # 架构和预防措施
   [Azure CLI命令和配置更改]
   ```

   ## 📈 监控建议
   - **要配置的警报**：[推荐警报列表]
   - **要创建的仪表板**：[监控仪表板建议]
   - **定期健康检查**：[推荐频率和范围]

   ## ✅ 验证步骤
   - [ ] 通过日志验证问题解决
   - [ ] 确认性能改进
   - [ ] 测试应用程序功能
   - [ ] 更新监控和警报
   - [ ] 记录经验教训

   ## 📝 预防措施
   - [防止类似问题的建议]
   - [流程改进]
   - [监控增强]
   ```

## 错误处理
- **未找到资源**：提供资源名称/位置规范指导
- **身份验证问题**：指导用户完成Azure身份验证设置
- **权限不足**：列出资源访问所需的RBAC角色
- **无可用日志**：建议启用诊断设置并等待数据
- **查询超时**：将分析分解为较小的时间窗口
- **服务特定问题**：提供带限制说明的通用健康评估

## 成功标准
- ✅ 资源健康状况准确评估
- ✅ 所有重要问题已识别和分类
- ✅ 主要问题完成根本原因分析
- ✅ 提供了带具体步骤的可操作修复计划
- ✅ 包括监控和预防建议
- ✅ 按业务影响对问题进行清晰优先级排序
- ✅ 实施步骤包括验证和回滚程序