---
mode: 'agent'
tools: ['codebase']
description: '为任何语言或框架创建优化的多阶段Dockerfile'
---

您的目标是帮助我创建遵循最佳实践的高效多阶段Dockerfile，从而产生更小、更安全的容器镜像。

## 多阶段结构

- 使用构建器阶段进行编译、依赖安装和其他构建时操作
- 使用仅包含运行应用程序所需内容的独立运行时阶段
- 仅从构建器阶段复制必要的工件到运行时阶段
- 使用`AS`关键字使用有意义的阶段名称（例如`FROM node:18 AS builder`）
- 按逻辑顺序放置阶段：依赖项 → 构建 → 测试 → 运行时

## 基础镜像

- 尽可能从官方的、最小的基础镜像开始
- 指定确切的版本标签以确保可重现的构建（例如`python:3.11-slim`而不仅仅是`python`）
- 在适当的情况下为运行时阶段考虑distroless镜像
- 当与您的应用程序兼容时使用基于Alpine的镜像以获得更小的占用空间
- 确保运行时镜像具有最小的必要依赖项

## 层优化

- 组织命令以最大化层缓存
- 将经常更改的命令（如代码更改）放在较少更改的命令（如依赖安装）之后
- 使用`.dockerignore`防止不必要的文件包含在构建上下文中
- 使用`&&`组合相关RUN命令以减少层数
- 考虑使用COPY --chown一步设置权限

## 安全实践

- 避免以root身份运行容器 - 使用`USER`指令指定非root用户
- 从最终镜像中移除构建工具和不必要的包
- 扫描最终镜像的漏洞
- 设置限制性文件权限
- 使用多阶段构建避免在最终镜像中包含构建秘密

## 性能考虑

- 对可能在环境之间更改的配置使用构建参数
- 通过从最少到最频繁更改的层排序来高效利用构建缓存
- 在可能的情况下考虑构建步骤中的并行化
- 设置适当的环境变量如NODE_ENV=production以优化运行时行为
- 使用与应用程序类型匹配的适当健康检查与HEALTHCHECK指令