---
applyTo: "spec-driven-workflow-v1.instructions.md"
---

<!-- 本文件为自动翻译，供参考。请结合实际需求进行校对和完善。-->

# 规范驱动工作流 v1

**规范驱动工作流：**
连接需求与实现的桥梁。

**始终维护以下文档：**

- **`requirements.md`**：用结构化 EARS 语法记录用户故事和验收标准。
- **`design.md`**：技术架构、时序图、实现注意事项。
- **`tasks.md`**：详细、可追踪的实现计划。

## 通用文档框架

**文档规则：**
所有文档以详细模板为唯一事实来源。

**摘要格式：**
仅用于变更日志、PR 描述等简明场景。

### 详细文档模板

#### 行动文档模板（所有步骤/执行/测试）

```bash
### [TYPE] - [ACTION] - [TIMESTAMP]
**目标**: [要完成的目标]
**上下文**: [当前状态、需求、前置步骤引用]
**决策**: [所选方案及理由，引用决策记录]
**执行**: [具体操作步骤和参数，涉及代码请写明文件路径]
**输出**: [完整结果、日志、命令输出、指标]
**验证**: [验证方法和结果，失败时写明补救方案]
**下一步**: [自动衔接的下一步行动]
```

#### 决策记录模板（所有决策）

```bash
### 决策 - [TIMESTAMP]
**决策**: [决策内容]
**上下文**: [决策背景和数据]
**选项**: [备选方案及优缺点]
**理由**: [为何选此方案，权衡说明]
**影响**: [对实现、维护、性能的影响]
**复盘**: [复盘条件或时间点]
```

### 摘要格式（用于报告）

#### 精简行动日志

每条日志由完整行动文档生成。

`[TYPE][TIMESTAMP] 目标: [X] → 行动: [Y] → 结果: [Z] → 下一步: [W]`

#### 精简决策记录

用于 PR 摘要或高层报告。

`决策: [X] | 理由: [Y] | 影响: [Z] | 复盘: [Date]`

## 执行工作流（6 阶段循环）

**不得跳步，术语统一，减少歧义。**

### **阶段 1: 分析**

**目标：**

- 理解问题
- 分析现有系统
- 产出清晰、可测试的需求
- 思考可行方案及影响

**检查清单：**

- [ ] 阅读所有代码、文档、测试、日志 - 记录文件清单、摘要、初步分析
- [ ] 用 EARS 语法定义需求 - 将需求转为结构化、可测试的表达 - 格式：`WHEN [条件]，THE SYSTEM SHALL [行为]`
- [ ] 明确依赖和约束 - 画依赖图，标风险和缓解措施
- [ ] 梳理数据流和交互 - 画系统交互图和数据模型
- [ ] 列举边界和异常 - 记录边界矩阵和潜在失败点
- [ ] 评估信心 - 生成信心分（0-100%），并说明理由

**关键约束：**

- **需求不清前不得进入下一阶段。**

### **阶段 2: 设计**

**目标：**

- 产出完整技术设计和详细实现计划

**检查清单：**

- [ ] **按信心分自适应执行策略：**

  - **高信心（>85%）**
    - 直接写详细实现计划
    - 跳过 POC
    - 全自动实现
    - 保持标准文档
  - **中信心（66–85%）**
    - 先做 POC 或 MVP
    - 明确 POC/MVP 成功标准
    - 先验证再细化计划
    - 记录 POC/MVP 目标、执行、验证
  - **低信心（<66%）**
    - 先调研和知识积累
    - 语义搜索、分析类似实现
    - 形成调研文档
    - 再回到分析阶段
    - 如仍低信心则升级处理

- [ ] **`design.md` 记录技术设计：**

  - **架构**：组件和交互概览
  - **数据流**：图和说明
  - **接口**：API、schema、函数签名
  - **数据模型**：结构和数据库 schema

- [ ] **记录错误处理：**

  - 错误矩阵和响应方案

- [ ] **定义单元测试策略。**

- [ ] **`tasks.md` 记录实现计划：**
  - 每步写明描述、预期结果、依赖

**关键约束：**

- **设计和计划未定前不得实现。**

### **阶段 3: 实现**

**目标：**

- 按设计和计划写生产级代码

**检查清单：**

- [ ] 小步提交，便于测试 - 每步记录变更、结果、测试链接
- [ ] 先实现依赖，再实现上层 - 记录顺序、理由、验证
- [ ] 遵循规范 - 记录遵循与偏差及理由
- [ ] 注释写意图（why），非细节（what）
- [ ] 按计划建文件 - 记录文件创建日志
- [ ] 实时更新任务状态

**关键约束：**

- **未全部测试前不得合并或部署。**

### **阶段 4: 验证**

**目标：**

- 验证实现是否满足需求和质量标准

**检查清单：**

- [ ] 跑自动化测试 - 记录输出、日志、覆盖率 - 失败要分析和补救
- [ ] 必要时手动验证 - 记录流程、清单、结果
- [ ] 测试边界和异常 - 记录结果和证据
- [ ] 验证性能 - 记录指标和分析
- [ ] 记录执行轨迹 - 路径分析和运行时行为

**关键约束：**

- **未全部验证和修复前不得进入下一阶段。**

### **阶段 5: 复盘**

**目标：**

- 改进代码、补文档、分析性能

**检查清单：**

- [ ] 重构提升可维护性 - 记录决策、前后对比、影响
- [ ] 更新所有文档 - 保证 README、图、注释最新
- [ ] 记录改进建议 - 形成待办清单
- [ ] 验证成功标准 - 记录最终验证矩阵
- [ ] 复盘分析 - 反思效率、工具、流程
- [ ] 自动生成技术债务 issue - 记录清单和补救计划

**关键约束：**

- **未补全文档和改进前不得关闭阶段。**

### **阶段 6: 交付**

**目标：**

- 打包交付、准备评审、衔接下个任务

**检查清单：**

- [ ] 生成高层摘要 - 用精简决策记录格式
- [ ] 准备 PR（如需）：
  1. 高层摘要
  2. 变更日志
  3. 验证和决策记录链接
  4. requirements.md、design.md、tasks.md 链接
- [ ] 整理工作区 - 归档中间文件、日志到 `.agent_work/`
- [ ] 衔接下个任务 - 记录交接或完成

**关键约束：**

- **未完成交付前不得视为已完成。**

## 故障排查与重试

**遇到错误、歧义或阻塞时：**

**检查清单：**

1. **重分析**：
   - 回到分析阶段，确认需求和约束
2. **重设计**：
   - 回到设计阶段，更新设计和计划
3. **重计划**：
   - 调整 tasks.md
4. **重试执行**：
   - 修正后重试
5. **升级处理**：
   - 多次失败后按升级流程处理

**关键约束：**

- **未解决前不得继续，所有排查过程需记录。**

## 技术债务管理（自动化）

### 识别与记录

- **代码质量**：用静态分析持续评估
- **权衡**：所有权衡决策需记录
- **工作区**：监控结构和命名漂移
- **文档**：跟踪不全、过时、缺失

### 自动 issue 模板

```text
**标题**: [技术债务] - [简述]
**优先级**: [高/中/低]
**位置**: [文件路径和行号]
**原因**: [为何产生，引用决策记录]
**影响**: [当前和未来影响]
**补救**: [具体措施]
**工作量**: [估算]
```

### 补救（自动优先级排序）

- 风险优先，依赖分析
- 估算工作量
- 大型重构建议分阶段

## 质量保障（自动化）

### 持续监控

- **静态分析**：风格、质量、安全、架构
- **动态分析**：运行时性能和行为
- **文档**：自动检查完整性和准确性

### 质量指标（自动跟踪）

- 覆盖率和缺口分析
- 圈复杂度
- 可维护性指数
- 技术债务比
- 文档覆盖率

## EARS 语法参考

**EARS（简易需求表达法）** - 标准格式：

- **通用**：`THE SYSTEM SHALL [行为]`
- **事件驱动**：`WHEN [事件] THE SYSTEM SHALL [行为]`
- **状态驱动**：`WHILE [状态] THE SYSTEM SHALL [行为]`
- **异常**：`IF [异常] THEN THE SYSTEM SHALL [响应]`
- **可选**：`WHERE [条件] THE SYSTEM SHALL [行为]`
- **复杂**：可组合

每条需求必须：

- **可测试**
- **无歧义**
- **必要**
- **可行**
- **可追溯**
