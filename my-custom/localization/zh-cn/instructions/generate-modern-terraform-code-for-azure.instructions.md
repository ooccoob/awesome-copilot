---
description: "生成现代 Azure Terraform 代码的最佳实践指南"
applyTo: "**/*.tf"
---

## 1. 使用最新 Terraform 及 Provider

始终以最新稳定版 Terraform 和 Azure provider 为目标。在代码中指定所需的 Terraform 及 provider 版本，并保持 provider 及时更新以获得新特性和修复。

## 2. 代码结构清晰

合理拆分 Terraform 配置文件：

- `main.tf`：资源定义
- `variables.tf`：输入参数
- `outputs.tf`：输出参数
- 命名规范统一，格式化（`terraform fmt`）

这样便于维护和导航。

## 3. 封装为模块

将可复用的基础设施组件封装为 Terraform 模块。对于多处使用的资源集合：

- 创建独立模块，定义变量/输出
- 通过模块引用，避免重复代码
- 提升复用性和一致性

## 4. 善用变量与输出

- **参数化**所有可配置项，变量需声明类型和描述
- **可选变量**应提供默认值
- **输出**关键资源属性，便于其他模块或用户引用
- **敏感值**需标记保护机密

## 5. Provider 选择（AzureRM vs AzAPI）

- **优先用 `azurerm` provider**，其稳定性高且覆盖大部分 Azure 服务
- **仅在需要最新特性或 azurerm 不支持的资源时用 `azapi` provider**
- **在代码注释中说明选择原因**
- 两者可同时用，但不确定时优先选 `azurerm`

## 6. 精简依赖

- **不要引入**超出项目范围的 provider 或模块，除非获得确认
- 如需特殊 provider（如 `random`、`tls`）或外部模块：
  - 注释说明原因
  - 需用户批准
- 保持基础设施栈精简，避免不必要复杂度

## 7. 保证幂等性

- 配置应可多次 apply，结果一致
- **避免非幂等操作**：
  - 每次 apply 都运行的脚本
  - 可能重复创建冲突的资源
- **多次 `terraform apply` 测试**，确保第二次无变更
- 用资源生命周期或条件表达式优雅处理漂移或外部变更

## 8. 状态管理

- **用远程后端**（如 Azure Storage 带锁）安全存储 state
- 支持团队协作
- **严禁将 state 文件提交到源码库**
- 保证状态一致，防止冲突

## 9. 文档与架构图

- **维护最新文档**
- **每次代码变更后更新 README.md**，同步变量、输出、用法说明
- 可用 `terraform-docs` 工具自动化
- **架构图需同步更新**，反映基础设施变更
- 文档和图示有助于团队理解

## 10. 校验与测试

- **执行 `terraform validate`**，并审查 `terraform plan` 输出
- 及早发现错误或意外变更
- **建议自动化校验**：
  - CI 流水线
  - pre-commit 钩子
  - 强制格式化、lint、基础校验

---

> 本文档为自动翻译，仅供参考。如有歧义请以英文原文为准。
