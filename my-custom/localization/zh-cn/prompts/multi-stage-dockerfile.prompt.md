---
mode: 'agent'
tools: ['codebase']
description: '为任意语言或框架创建优化的多阶段 Dockerfile'
---

你的目标是帮助我创建遵循最佳实践的高效多阶段 Dockerfile，从而得到更小、更安全的镜像。

## 多阶段结构

- 使用 builder 阶段进行编译、安装依赖及其他构建时操作
- 使用独立的 runtime 阶段，仅包含运行应用所必需的内容
- 仅从 builder 阶段复制运行所需的制品到 runtime 阶段
- 使用有意义的阶段名与 `AS` 关键字（如：`FROM node:18 AS builder`）
- 按逻辑顺序组织阶段：依赖 → 构建 → 测试 → 运行

## 基础镜像

- 优先使用官方、精简的基础镜像
- 使用精确的版本标签以确保可重复构建（例如使用 `python:3.11-slim` 而不是 `python`）
- 在合适场景下考虑为 runtime 阶段使用 distroless 镜像
- 当与应用兼容时可使用 Alpine 基础镜像以获得更小体积
- 确保 runtime 镜像仅包含最小必要依赖

## 层优化

- 组织命令以最大化缓存命中
- 将变化频繁的命令（如代码变更）放在变化较少的命令（如安装依赖）之后
- 使用 `.dockerignore` 排除不必要的构建上下文文件
- 将相关的 RUN 命令用 `&&` 合并以减少层数
- 考虑使用 `COPY --chown` 一步设置权限

## 安全实践

- 避免以 root 身份运行容器——使用 `USER` 指令指定非 root 用户
- 从最终镜像中移除构建工具与不必要的软件包
- 对最终镜像进行漏洞扫描
- 设置严格的文件权限
- 利用多阶段构建避免将构建机密泄露到最终镜像

## 性能考量

- 使用构建参数（build args）来配置在不同环境可能变化的内容
- 通过从“最不易变化”到“最易变化”的层顺序来高效利用缓存
- 在可能的情况下考虑并行化构建步骤
- 设置合适的环境变量（如 `NODE_ENV=production`）以优化运行时行为
- 根据应用类型使用 `HEALTHCHECK` 指令配置健康检查
