# AT28C256 EEPROM 仿真规范

## 概述

本文档指定如何在基于 6502 的系统仿真器中**仿真 AT28C256（32 KB 并行 EEPROM）**。目标是“行为准确性”，适用于 SBC、监视器和真实 ROM 映像，而不仅仅是通用的文件支持存储。

AT28C256 通常用作 6502 系统中的 **ROM**，但它是“电可写”的，并且具有与 SRAM 不同的时序行为。

---

## 芯片总结

|参数|价值|
| -------------- | ---------------------- |
|产能 | 32 KB（256 KB）|
|组织| 32,768 x 8 |
|地址行| A0-A14 |
|数据线| D0-D7 |
|电源电压| 5V |
|典型用途| ROM/固件存储|

---

## 引脚定义

|针 |名称 |功能|
| ------ | ------------- | ---------------------- |
| A0-A14 |地址 |字节地址|
| D0-D7 |数据|数据总线|
| /CE |芯片启用|激活芯片|
| /OE |输出使能|启用输出驱动器|
| /我们|写使能|触发写周期|
| VCC | +5V |电源|
|接地 |地面|参考|

---

## 读取周期行为

读取发生在以下情况：

```
/CE = 0
/OE = 0
/WE = 1
```

### 阅读规则

* 在断言 `/OE` 之前，地址必须稳定
* 访问时间后数据出现在 D0-D7 上（在大多数仿真器中被忽略）
* 当 `/OE = 1` 或 `/CE = 1` 时，输出为**高阻抗**

### 模拟器行为

```text
if CE == 0 and OE == 0 and WE == 1:
    data_bus = memory[address]
else:
    data_bus = Z
```

---

## 写周期行为

写入发生在以下情况：

```
/CE = 0
/WE = 0
```

（`/OE` 在写入期间通常为高电平）

### 重要的 EEPROM 特性

* 写入**不是瞬时的**
* 每次写入都会触发一个**内部编程周期**
* 在编程期间，读取可能会返回未定义的数据

---

## 写入时序模型（简化）

### 真实硬件

|参数|典型|
| --------------- | -------- |
|字节写入时间|约 200 µs |
|页面尺寸| 64 字节 |
|页面写入时间| 〜10 毫秒 |

### 仿真器简化选项

#### 选项 A - 即时写入（常见）

* 写入立即更新内存
* 无忙碌状态
* 推荐用于早期模拟器

#### 选项 B - 基于周期的忙状态（高级）

* 跟踪“正在进行写入”计时器
* 写入期间读取返回最后一个值或 `0xFF`
* 写入被忽略，直到周期完成

---

## 页写入仿真（可选）

* 页面大小：**64 字节**
* 超时之前在同一页面内写入一起提交
* 跨页边界在页内换行（硬件怪癖）

简化规则：

```text
page_base = address & 0xFFC0
page_offset = address & 0x003F
```

---

## 写保护行为

某些系统在编程后将 EEPROM 视为 **ROM-only**。

模拟器可能支持：

* 只读模式（忽略写入）
* 可编程模式（允许写入）
* 运行时切换（模拟编程跳线）

---

## 上电状态

* EEPROM 保留内容
* 上电时没有未定义的数据

模拟器应该：

* 从图像文件加载内容
* 重置后保留数据

---

## 总线争用规则

|状况 |行为 |
| ------------------- | ----------------- |
| /CE = 1 |数据总线= Z |
| /OE = 1 |数据总线= Z |
| /WE = 0 和 /OE = 0 |未定义（避免）|

模拟器可以：

* 优先写入
* 或标记无效状态

---

## 6502 系统中的内存映射

常见布局：

```
$0000-$7FFF  RAM
$8000-$FFFF  AT28C256 EEPROM
```

### 重置向量使用

|矢量|地址 |
| ------ | ----------- |
|重置| $FFFC-$FFFD |
|纳米医学| $FFFA-$FFFB |
|中断请求| $FFFE-$FFFF |

---

## 模拟器 API 模型

```c
typedef struct {
    uint8_t memory[32768];
    bool write_enabled;
    bool busy;
    uint32_t busy_cycles;
} AT28C256;
```

### 阅读

```c
uint8_t eeprom_read(addr);
```

### 写

```c
void eeprom_write(addr, value);
```

---

## 推荐的模拟器默认值

|特色 |设置|
| ------------- | ----------- |
|写入延迟|已禁用 |
|页面模式|已禁用 |
|写保护|已启用 |
|坚持|文件支持 |

---

## 测试清单

* 重置矢量获取
* 正常执行下ROM读取
* 在只读模式下忽略写入
* 正确的地址掩码（15 位）
* 禁用时无总线驱动

---

## 参考文献

* [AT28C256 数据表 (Microchip)](https://ww1.microchip.com/downloads/aemDocuments/documents/MPD/ProductDocuments/DataSheets/AT28C256-Industrial-Grade-256-Kbit-Paged-Parallel-EEPROM-Data-Sheet-DS20006386.pdf)
* [Ben Eater 6502电脑系列](https://eater.net/6502)
  * __自动0__
* [6502.org 内存映射注释](https://6502.co.uk/lesson/memory-map)

---

## 注释

该规范有意反映**真实的硬件怪癖**，同时允许仿真器作者在简单性和准确性之间进行选择。它适用于：

* 教育模拟器
* SBC模拟
* ROM开发流程
* 与 6502 + 6522 + SRAM 仿真集成
