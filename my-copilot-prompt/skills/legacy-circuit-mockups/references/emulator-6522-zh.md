# 6522 VIA（通用接口适配器）仿真规范

用于**仿真 MOS 技术/WDC 6522 VIA** 的技术 Markdown 规范，适用于 6502 系列仿真器、SBC 仿真器和逆计算软件环境。

---

## 1.范围

本文档定义了模拟所需的功能行为：

* MOS 技术 6522 威盛
* WDC 65C22 VIA（CMOS 型号，如有注明）

超出范围：

* 模拟电气特性
* 总线争用和传播延迟
* 未记录的硅竞争条件

---

## 2. 芯片概述

### 核心特点

|特色 |描述 |
| ---------------- | ------------------------------------ |
| I/O 端口 |两个 8 位双向端口（A、B）|
|定时器|两个可编程定时器|
|移位寄存器| 8位串行移位寄存器|
|中断系统|可屏蔽、优先 |
|握手| CA1/CA2、CB1/CB2 控制线 |

---

## 3. 外部信号（逻辑模型）

|信号|方向 |目的|
| -------- | --------- | ------------------------ |
| PA0-PA7|输入/输出|端口 A |
| PB0-PB7 |输入/输出| B 港 |
| CA1、CA2 |输入/输出|控制线A |
| CB1、CB2 |输入/输出|控制线B |
|中断请求|输出|向CPU发出中断请求|
| CS1、CS2 |输入 |片选|
|读/写|输入 |读/写|
| RS0-RS3 |输入 |注册选择|

---

## 4. 注册地图

使用 RS3-RS0 选择寄存器。

|地址 |名称 |读/写|描述 |
| ------- | ----------- | --- | -------------------------------- |
| 0 | ORB / IRB |读/写 |输出/输入寄存器B |
| 1 |奥拉 / 爱尔兰共和军 |读/写|输出/输入寄存器A |
| 2 | DDRB |读/写 |数据方向寄存器B|
| 3 | DDRA |读/写 |数据方向寄存器A |
| 4 | T1C-L |右 |定时器 1 计数器低 |
| 5 | T1C-H |右 |定时器 1 计数器高 |
| 6 | T1L-L |西 |定时器 1 锁存低电平 |
| 7 | T1L-H |西 |定时器 1 锁存高电平 |
| 8 | T2C-L |右 |定时器 2 计数器低 |
| 9 | T2C-H |右 |定时器 2 计数器高 |
| 10 | 10 SR |读/写|移位寄存器|
| 11 | 11 ACR |读/写 |辅助控制寄存器|
| 12 | 12聚合酶链反应 |读/写 |外设控制寄存器|
| 13 |仪表飞行规则 |读/写|中断标志寄存器|
| 14 | 14 IER |读/写 |中断使能寄存器|
| 15 | 15 ORA（无 HS）|读/写 |输出寄存器 A（无握手）|

---

## 5. 数据方向寄存器

* 位 = 1 输出
* 位 = 0 输入

```text
output = ORx & DDRx
input  = external & ~DDRx
```

---

## 6. 端口行为

### 阅读

* 返回配置为输入的位的输入引脚
* 返回配置为输出的位的输出锁存器

### 写

* 仅更新输出锁存器
* 实际引脚值取决于 DDR

---

## 7. 定时器

### 定时器1（T1）

* 16位递减计数器
* 可以产生中断
* 可选 PB7 切换

### 定时器2（T2）

* 16位递减计数器
* 单次或脉冲计数 (CB1)

### 定时器仿真规则

* 每个 CPU 周期递减一次
* 适当时从闩锁重新加载
* 设置下溢中断标志

---

## 8. 移位寄存器（SR）

通过 ACR 控制的模式：

* 残疾人
* 在 CB1 时钟下移入
* 在系统时钟下移出

模拟器要求：

* 8 位移位
* 正确的位顺序
* 可选的外部时钟处理

---

## 9. 控制寄存器

### 辅助控制寄存器（ACR）

控制：

* 定时器1模式
* 定时器2模式
* 移位寄存器模式
* PB7行为

### 外设控制寄存器 (PCR)

控制：

* CA1/CB1 边缘灵敏度
* CA2/CB2 握手/脉冲/输出模式

---

## 10. 中断系统

### 中断标志寄存器（IFR）

|位|来源 |
| --- | -------------------------- |
| 0 | CA2 |
| 1 | CA1 |
| 2 |移位寄存器|
| 3 | CB2 |
| 4 | CB1 |
| 5 |定时器2 |
| 6 |定时器1 |
| 7 |任何中断（逻辑或）|

### 中断允许寄存器（IER）

* 位 7 = 设置/清除模式
* 位 0-6 启用各个源

### 中断请求逻辑

```text
IRQ = (IFR & IER & 0x7F) != 0
```

---

## 11. 握手线

### CA1 / CB1

* 边缘检测输入
* 触发中断

### CA2 / CB2

* 输入或输出
* 脉冲或握手模式

模拟器必须：

* 履带销状态
* 检测配置的边缘

---

## 12. 重置行为

复位时：

* DDRx = $00
* ORx = $00
* 计时器停止
* IFR 已清除
* IER 清除
* IRQ 无效

---

## 13. 读/写副作用

|注册 |副作用 |
| ----------- | ------------------------ |
| ORA/ORB |清除握手标志|
| T1C-H 写 |加载并启动定时器 1 |
| IFR 写 |清除写入位|
| IER 写 |设置或清除启用 |

---

## 14. 仿真时序级别

|水平|描述 |
| -------------- | ------------------------- |
|功能性|正确的注册行为 |
|基于周期|每个 CPU 周期的定时器滴答声 |
|周期精确 |与真实威盛时序匹配 |

---

## 15. 与 6502 仿真器集成

```text
CPU cycle  VIA tick  update timers  update IRQ
```

* VIA 的时钟必须与 CPU 同步
* CPU 在指令边界采样 IRQ 线

---

## 16. 测试和验证

### 推荐测试

* VIA 定时器测试 ROM
* 端口读/写测试
* 中断优先级测试

### 验证清单

* 计时器正确计数
* IRQ 正确置位和清除
* DDR 行为正确
* 实施的副作用

---

## 17. 差异：6522 与 65C22（总结）

|特色| 6522 | 65C22 | 65C22
| -------------- | ------ | -------- |
|电源|更高 |降低|
|小数怪癖 |不适用 |固定|
|定时器精度| NMOS |改进|

---

## 18. 参考链接

* [https://www.westerndesigncenter.com/wdc/documentation](https://www.westerndesigncenter.com/wdc/documentation)
* [https://www.princeton.edu/~mae412/HANDOUTS/Datasheets/6522.pdf](https://www.princeton.edu/~mae412/HANDOUTS/Datasheets/6522.pdf)
* [https://www.nesdev.org/wiki/6522](https://www.nesdev.org/wiki/6522)

---

**文档范围：** 6522 VIA 的软件仿真
**受众：** 仿真器开发人员、SBC 设计人员
**状态：**稳定的技术参考
