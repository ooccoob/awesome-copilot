# 6502 CPU 仿真规范

用于**模拟 MOS Technology 6502 CPU 系列**的技术 Markdown 规范，适用于软件模拟器、教育工具、测试框架和逆计算项目。

---

## 1.范围

该规范描述了模拟的功能要求：

* MOS 6502
* WDC 65C02（如有注明）

超出范围：

* 循环精确的模拟行为
* 物理总线争用
* 未记录的硅缺陷（除非明确实施）

---

## 2.CPU概述

### 核心特征

|特色 |价值|
| ------------- | ------------- |
|数据宽度| 8 位 |
|地址宽度| 16 位 |
|地址空间| 64 KB |
|字节顺序 |小尾数 |
|时钟|单相|

---

## 3. 寄存器

|注册 |尺寸|描述 |
| -------- | ------ | -------------------------- |
|一个 | 8 位 |蓄能器|
| X | 8 位 |索引寄存器|
|是 | 8 位 |索引寄存器|
| SP | 8 位 |堆栈指针（页$01xx）|
|电脑| 16 位 |程序计数器|
|普 | 8 位 |处理器状态标志|

### 状态标志 (P)

|位|名称 |意义|
| --- | ---- | ----------------------------- |
| 7 |尼 |负面|
| 6 | V |溢出|
| 5 | - |未使用（按下时始终为 1）|
| 4 |乙|休息 |
| 3 | d |十进制|
| 2 |我| IRQ 禁用 |
| 1 | Z|零|
| 0 | C |携带|

---

## 4. 内存模型

### 寻址

* 16 位地址总线 (`$0000-$FFFF`)
* 字节寻址

### 所需的仿真器接口

```text
read(address)  -> byte
write(address, byte)
```

### 堆栈行为

* 堆栈基址：`$0100`
* 推送：`write($0100 + SP, value); SP--`
* 拉：`SP++; value = read($0100 + SP)`

---

## 5. 复位和中断处理

### 复位顺序

1. 设置 `I = 1`
2. 设置 `SP = $FD`
3. 清除 `D`
4. 从 `$FFFC-$FFFD` 加载 `PC`

### 中断向量

|中断|矢量地址|
| --------- | -------------- |
|纳米医学| __代码0__ |
|重置 | __代码0__ |
| IRQ/BRK | __代码0__ |

---

## 6. 取指令-译码-执行周期

### 执行循环（概念）

```text
opcode = read(PC++)
decode opcode
fetch operands
execute instruction
update flags
increment cycles
```

---

## 7. 寻址模式

|模式|示例|笔记|
| ---------------- | ------------- | --------------------- |
|立即 | __代码0__ |恒定|
|零页| __代码0__ |包装价格 $00FF |
|绝对| __代码0__ |完整地址 |
|索引| __代码0__ |可选页面惩罚 |
|间接| __代码0__ |页面换行错误 |
|间接索引| __代码0__ | ZP 索引 |
|间接索引| __代码0__ | ZP指针|

---

## 8. 指令集要求

### 类别

* 加载/存储
* 算术（ADC、SBC）
* 逻辑（AND、ORA、EOR）
* 移位和旋转
* 分支机构
* 堆栈操作
* 系统控制

### 十进制模式 (NMOS 6502)

* 适用于 `ADC` 和 `SBC`
* 当 `D = 1` 时使用 BCD 算术

---

## 9. 标记行为规则

|指令类型 |受影响的标志 |
| ---------------- | -------------- |
|负载 | N、Z |
| ADC/SBC | N、V、Z、C |
| CMP/CPX/CPY | N、Z、C |
|递增/递减 | N、Z |
|班次 | N、Z、C |

---

## 10. 周期盘点

### 循环精度等级

|水平|描述 |
| -------------------- | -------------------- |
|功能性|仅正确结果 |
|指令准确 |固定周期计数 |
|周期精确 |跨页惩罚 |

### 页面边界惩罚

* 采取分支：+1 周期
* 分支跨页：+2 个周期
* 索引负载跨页：+1 周期

---

## 11. 已知的硬件怪癖 (NMOS 6502)

|怪癖|描述 |
| ---------------- | ------------------------------- |
| JMP 间接错误 |页边界高字节换行 |
| BRK 设置 B 标志 |仅当被推动时 |
|未使用的标志位|始终读作 1 |

---

## 12. 非法/未记录的操作码（可选）

* 许多操作码执行复合操作
* 行为因芯片版本而异
* 应禁用或明确启用

---

## 13. 计时和时钟

* 每多个时钟周期执行一条指令
* 模拟器可以在每个主机滴答声中执行指令
* I/O 时序所需的周期计数器

---

## 14. 与外设集成

### 内存映射 I/O

```text
if address in IO range:
    delegate to device
```

示例：

* 6522 威盛
* 串口
* 视频硬件

---

## 15. 测试和验证

### 推荐的测试 ROM

* Klaus Dormann 6502 功能测试
* 中断和十进制模式测试

### 验证清单

* 所有指令均正确执行
* 标志匹配参考行为
* 载体处理得当
* 堆栈操作正确

---

## 16. 参考链接

* [https://www.masswerk.at/6502/6502_instruction_set.html](https://www.masswerk.at/6502/6502_instruction_set.html)
* [https://www.nesdev.org/wiki/6502](https://www.nesdev.org/wiki/6502)
* [https://github.com/Klaus2m5/6502_65C02_function_tests](https://github.com/Klaus2m5/6502_65C02_functional_tests)
* [https://en.wikipedia.org/wiki/MOS_Technology_6502](https://en.wikipedia.org/wiki/MOS_Technology_6502)

---

**文档范围：** 6502 CPU 的软件仿真
**受众：** 模拟器开发人员、逆向计算工程师
**状态：**稳定的技术参考
