---
description: "Symfony development standards aligned with official Symfony Best Practices"
applyTo: "**/*.php, **/*.yaml, **/*.yml, **/*.xml, **/*.twig"
---

# Symfony 开发说明

遵循官方 Symfony 最佳实践和核心框架理念开发 Symfony 应用程序的说明。

## 项目背景
- Symfony（最新稳定版或 LTS）
- 默认 Symfony 目录结构
- 启用自动装配和自动配置
- 当需要持久性时使用 Doctrine ORM
- 用于模板的树枝
- Symfony 表单、验证器、安全性、Messenger（根据需要）
- 用于测试的 PHPUnit
- 支持的基于属性的配置

## 项目结构
- 使用默认的 Symfony 目录结构
- 不要为应用程序代码创建捆绑包
- 使用 PHP 命名空间组织应用程序代码
- 将配置保存在 `config/` 中，将应用程序代码保存在 `src/` 中，将模板保存在 `templates/` 中

## 配置

### 环境配置
- 使用环境变量进行基础设施相关配置
- 使用 `.env` 文件定义特定于环境的值
- 不要使用环境变量来控制应用程序行为

### 敏感配置
- 使用 Symfony Secrets 存储机密（API 密钥、凭证）
- 切勿将机密提交到存储库

### 应用程序配置
- 使用 `config/services.yaml` 中的参数进行应用程序行为配置
- 仅在需要时覆盖每个环境的参数
- 为参数添加前缀 `app.` 以避免冲突
- 使用简短的描述性参数名称
- 将 PHP 常量用于很少更改的配置值

## 服务和依赖注入
- 专门使用依赖注入
- 更喜欢构造函数注入
- 默认使用自动装配和自动配置
- 尽可能保持服务的私密性
- 避免通过 `$container->get()` 访问服务
- 使用 YAML 作为服务配置的首选格式
- 使用可以提高解耦性或清晰度的接口

## 控制器
- 扩展 `AbstractController`
- 保持控制器精简并专注于粘合代码
- 不要将业务逻辑放在控制器中
- 使用属性来配置路由、缓存和安全性
- 对服务使用依赖注入
- 在方便且合适的情况下使用实体值解析器
- 需要时通过存储库显式执行复杂查询

## 教义与坚持
- 使用 Doctrine 实体作为普通 PHP 对象
- 使用 PHP 属性定义 Doctrine 映射
- 使用存储库来查询数据
- 避免将业务逻辑放入存储库中
- 对所有架构更改使用迁移

## 模板（树枝）
- 使用snake_case作为模板名称、目录和变量
- 使用下划线作为模板片段前缀
- 让模板专注于演示
- 避免 Twig 模板中的业务逻辑
- 默认转义输出
- 除非内容可信且已清理，否则避免使用 `|raw`

## 表格
- 将表单定义为 PHP 类
- 不要直接在控制器中构建表单
- 在模板中添加表单按钮，而不是在表单类中
- 定义底层对象的验证约束
- 使用单个控制器操作来渲染和处理每个表单
- 仅当需要多次提交时才在控制器中定义提交按钮

## 验证
- 使用 Symfony 验证器约束
- 在应用程序边界验证数据
- 当需要重用时，优先选择对象级验证而不是仅表单验证

## 国际化
- 使用 XLIFF 翻译文件
- 使用翻译键而不是文字内容字符串
- 使用表达目的而非位置的描述性关键词

## 安全性
- 除非需要多个系统，否则首选单个防火墙
- 使用自动密码哈希器
- 使用投票者进行复杂的授权逻辑
- 避免属性中复杂的安全表达式

## 网络资产
- 使用AssetMapper管理Web资产
- 除非需要，否则避免不必要的前端构建复杂性

## 异步处理
- 使用 Symfony Messenger 执行异步和后台任务
- 保持消息处理程序小而集中
- 为失败消息配置失败传输

## 测试
- 使用 `WebTestCase` 编写功能测试
- 添加冒烟测试以确保所有公共 URL 均成功响应
- 在功能测试中硬编码 URL，而不是生成路由
- 在适合隔离逻辑的情况下使用单元测试
- 随着应用程序的发展逐步添加更多具体测试

## 一般准则
- 更喜欢清晰而不是抽象
- 在引入自定义模式之前遵循 Symfony 约定
- 保持配置明确且可读
- 避免过早优化
- 使用 Symfony Demo 作为参考实现
