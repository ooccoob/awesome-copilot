---
描述：“Terraform 公约和指南”
适用于：'**/*.tf'
---

# Terraform 约定

## 一般说明

- 使用 Terraform 来配置和管理基础设施。
- 对 Terraform 配置使用版本控制。

## 安全性

- 始终使用 Terraform 及其提供商的最新稳定版本。
  - 定期更新您的 Terraform 配置以纳入安全补丁和改进。
- 以安全的方式存储敏感信息，例如使用 AWS Secrets Manager 或 SSM Parameter Store。
  - 定期轮换凭证和机密。
  - 在可能的情况下，自动轮换机密。
- 使用 AWS 环境变量引用存储在 AWS Secrets Manager 或 SSM Parameter Store 中的值。
  - 这会将敏感值排除在 Terraform 状态文件之外。
- 切勿将 AWS 凭证、API 密钥、密码、证书或 Terraform 状态等敏感信息提交到版本控制。
  - 使用 `.gitignore` 从版本控制中排除包含敏感信息的文件。
- 始终在 Terraform 配置中将敏感变量标记为 `sensitive = true`。
  - 这可以防止敏感值显示在 Terraform 计划或应用输出中。
- 使用 IAM 角色和策略来控制对资源的访问。
  - 分配权限时遵循最小权限原则。
- 使用安全组和网络 ACL 来控制对资源的网络访问。
- 尽可能在私有子网中部署资源。
  - 仅将公有子网用于需要直接访问 Internet 的资源，例如负载均衡器或 NAT 网关。
- 对静态和传输中的敏感数据使用加密。
  - 为 EBS 卷、S3 存储桶和 RDS 实例启用加密。
  - 使用 TLS 进行服务之间的通信。
- 定期检查和审核您的 Terraform 配置是否存在安全漏洞。
  - 使用 `trivy`、`tfsec` 或 `checkov` 等工具扫描 Terraform 配置是否存在安全问题。

## 模块化

- 为基础设施的每个主要组成部分使用单独的项目；这个：
  - 降低复杂性
  - 使管理和维护配置变得更加容易
  - 加速 `plan` 和 `apply` 操作
  - 允许独立开发和部署组件
  - 降低意外更改不相关资源的风险
- 使用模块来避免重复配置。
  - 使用模块来封装相关的资源和配置。
  - 使用模块来简化复杂的配置并提高可读性。
  - 避免模​​块之间的循环依赖。
  - 避免不必要的抽象层；仅当模块增加价值时才使用它们。
    - 避免对单一资源使用模块；仅将它们用于相关资源组。
    - 避免模​​块过度嵌套；保持模块层次结构浅。
- 使用 `output` 块公开有关您的基础设施的重要信息。
  - 使用输出提供对其他模块或配置用户有用的信息。
  - 避免在输出中暴露敏感信息；如果输出包含敏感数据，则将输出标记为 `sensitive = true`。

## 可维护性

- 优先考虑可读性、清晰度和可维护性。
- 使用注释来解释复杂的配置以及为什么做出某些设计决策。
- 编写简洁、高效、惯用且易于理解的配置。
- 避免使用硬编码值；使用变量进行配置。
  - 在适当的情况下设置变量的默认值。
- 使用数据源检索有关现有资源的信息，而不需要手动配置。
  - 这降低了出错的风险，确保配置始终是最新的，并允许配置适应不同的环境。
  - 避免对在同一配置中创建的资源使用数据源；使用输出代替。
  - 避免或删除不必要的数据源；它们会减慢 `plan` 和 `apply` 操作。
- 对于多次使用的值使用 `locals` 以确保一致性。

## 样式和格式

- 遵循 Terraform 资源命名和组织的最佳实践。
  - 对资源、变量和输出使用描述性名称。
  - 在所有配置中使用一致的命名约定。
- 请遵循 **Terraform 样式指南** 进行格式化。
  - 使用一致的缩进（每级 2 个空格）。
- 将相关资源分组到同一文件中。
  - 对资源组使用一致的命名约定（例如 `providers.tf`、`variables.tf`、`network.tf`、`ecs.tf`、`mariadb.tf`）。
- 将 `depends_on` 块放置在资源定义的最开头，以使依赖关系清晰。
  - 仅在必要时使用 `depends_on` 以避免循环依赖。
- 将 `for_each` 和 `count` 块放置在资源定义的开头，以阐明资源的实例化逻辑。
  - 对集合使用 `for_each`，对数字迭代使用 `count`。
  - 将它们放在 `depends_on` 块之后（如果存在）。
- 将 `lifecycle` 块放置在资源定义的末尾。
- 按字母顺序排列每个文件中的提供者、变量、数据源、资源和输出，以便于导航。
- 将相关属性分组在块内。
  - 将必需的属性放在可选属性之前，并对每个部分进行相应的注释。
  - 用空行分隔属性部分以提高可读性。
  - 按字母顺序排列每个部分中的属性以便于导航。
- 使用空行分隔配置的逻辑部分。
- 使用 `terraform fmt` 自动格式化您的配置。
- 使用 `terraform validate` 检查语法错误并确保配置有效。
- 使用 `tflint` 检查样式违规并确保配置遵循最佳实践。
  - 定期运行 `tflint` 以在开发过程的早期发现样式问题。

## 文档

- 始终包含变量和输出的 `description` 和 `type` 属性。
  - 使用清晰简洁的描述来解释每个变量和输出的用途。
  - 对变量使用适当的类型（例如 `string`、`number`、`bool`、`list`、`map`）。
- 在适当的情况下使用注释记录您的 Terraform 配置。
  - 使用注释来解释资源和变量的用途。
  - 使用注释来解释复杂的配置或决策。
  - 避免多余的注释；评论应该增加价值和清晰度。
- 在每个项目中包含一个 `README.md` 文件，以提供项目及其结构的概述。
  - 包括设置和使用配置的说明。
- 使用 `terraform-docs` 自动生成配置文档。

## 测试

- 编写测试来验证 Terraform 配置的功能。
  - 对测试文件使用 `.tftest.hcl` 扩展名。
  - 编写测试来涵盖正面和负面场景。
  - 确保测试是幂等的并且可以多次运行而不会产生副作用。
