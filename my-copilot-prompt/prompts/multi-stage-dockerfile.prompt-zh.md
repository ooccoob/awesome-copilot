---
代理人：“代理人”
工具：['搜索/代码库']
描述：“为任何语言或框架创建优化的多阶段 Dockerfile”
---

您的目标是帮助我创建遵循最佳实践的高效多阶段 Dockerfile，从而生成更小、更安全的容器映像。

## 多级结构

- 使用构建器阶段进行编译、依赖项安装和其他构建时操作
- 使用单独的运行时阶段，仅包含运行应用程序所需的内容
- 仅将必要的工件从构建器阶段复制到运行时阶段
- 使用带有 `AS` 关键字的有意义的阶段名称（例如 `FROM node:18 AS builder`）
- 按逻辑顺序放置阶段：依赖项 → 构建 → 测试 → 运行时

## 基础图像

- 尽可能从官方的、最小的基础镜像开始
- 指定准确的版本标签以确保可重现的构建（例如，`python:3.11-slim` 而不仅仅是 `python`）
- 在适当的情况下考虑运行时阶段的 distroless 镜像
- 与您的应用程序兼容时，使用基于 Alpine 的映像可减少占用空间
- 确保运行时映像具有最少的必要依赖项

## 图层优化

- 组织命令以最大化层缓存
- 将频繁更改的命令（如代码更改）放在更改不频繁的命令（如依赖项安装）之后
- 使用 `.dockerignore` 防止不必要的文件包含在构建上下文中
- 将相关的 RUN 命令与 `&&` 结合起来以减少层数
- 考虑使用 COPY --chown 一步设置权限

## 安全实践

- 避免以 root 身份运行容器 - 使用 `USER` 指令指定非 root 用户
- 从最终映像中删除构建工具和不必要的包
- 扫描最终图像是否存在漏洞
- 设置限制性文件权限
- 使用多阶段构建以避免在最终映像中包含构建机密

## 性能考虑因素

- 使用构建参数进行可能在环境之间发生变化的配置
- 通过按更改次数从最少到最频繁的顺序对层进行排序，有效地利用构建缓存
- 尽可能考虑构建步骤的并行化
- 设置适当的环境变量（例如 NODE_ENV=product）以优化运行时行为
- 通过 HEALTHCHECK 指令对应用程序类型使用适当的运行状况检查
